<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Comments</title>
    <script
            src="http://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
            crossorigin="anonymous"></script>
</head>
<body>
    <div style="display:inline-flex; flex-wrap:wrap;">
        <div style="padding-right: 100px;">

            userName <input type="text" id="userName"><br>
            email <input type="text" id="email"><br>

            <button onclick="fetchUserList()">GetAllUser</button>
            <button onclick="addUser()">AddUser</button>
            <!--<button onclick="send()">PutUser</button>-->
            <!--<button onclick="send()">DeleteUser</button><br>-->

        </div>

        <div>
            userId<input type="text" id="userId"><br>
            content<input type="text" id="content"><br>

            <button onclick="fetchCommentList()">fetchCommentList</button>
            <button onclick="addComment()">AddComment</button>
            <!--<button onclick="send()">PutComment</button>-->
            <!--<button onclick="send()">DeleteComment</button><br>-->
        </div>
    </div>

    <div id="comments-list">

    </div>

    <div id="users-list">

    </div>



    <script>


        async function uploadFile(button, email){
            console.log(email);
            try {
                let fileInput = $("#upload_file")[0].files[0];
                let formData = new FormData(); // <form></form>
                formData.append("srcFile", fileInput);

                console.log(formData);

                let res = await $.ajax({
                    type: 'POST',
                    url: `/attachment/${email}`,
                    data: formData,
                    contentType: false,
                    processData: false
                })

                printUser();
            } catch (err) {
                console.error(err);
            }
        }

        function printCommentArray(response){
            $('#comments-list').html('');
            for(let i = 0; i<response.length; i++){
                printComment(response[i]);
            }
        }

        function printComment(comment){

            $('#comments-list').append(
                `<div style="display: flex;" id="line${comment.id}">
                            <div style="width: 150px;">${comment.userName}</div>
                            <div style="width: 350px; overflow: auto;">${comment.content}</div>
                            <div><button onclick="editComment(this, ${comment.id})">수정</button>
                            <button onclick="removeComment(this, ${comment.id})">삭제</button></div>
                            </div>`
            )
        }

        function printUser(){
            $('#users-list').
        }

        function printUserArray(response){
            $('#comments-list').html('');
            for(let i = 0; i<response.length; i++){
                printUser(response[i]);
            }
        }

        function printUser(user){
            console.log(user.email);
            $('#comments-list').append(
                `<div style="display: flex;" id="line${user.userId}">
                            <div style="width: 150px;">${user.userName}</div>
                            <div style="width: 350px; overflow: auto;">${user.email}</div>
                            <div style="width: 150px;">${user.originalName}</div>
                            <input type="file" id="upload_file">
                            <button onclick="uploadFile(this, '${user.email}')">파일업로드</button>
                            <button onclick="removeUser(this, ${user.userId})">삭제</button></div>
                            </div>`
            )
        }

        async function addUser(){
            let userName = $("#userName").val();
            let email = $("#email").val();
            console.log(userName);
            let requsetData = {
                userName : userName,
                email : email
            };
            let response = await $.post({
                url: '/user',
                contentType: 'application/json;',
                dataType: 'json',
                data: JSON.stringify(requsetData),
            });
            $("#comments-list").html(printUser(response));
        }

        async function addComment(){
            try{
                let userId = $("#userId").val();
                let content = $("#content").val();
                let requestData = {
                    userId : 260,
                    content : content
                };
                let response = await $.post({
                    url: '/comment',
                    contentType: 'application/json;',
                    dataType: 'json',
                    data: JSON.stringify(requestData),
                });
                $("#comments-list").html(printComment(response));
            } catch (e) {
                $('#comments-list').html(JSON.stringify(ex));
            }


        }
        let obj = null;
        async function fetchUserList(){
            try{
                let response = await $.get('/user');
                printUserArray(response);
            } catch (ex) {
                $('#comments-list').html(JSON.stringify(ex));

            }
        }

        async function fetchCommentList(){

            try{
                let response = await $.get('/comment');
                printCommentArray(response);
            } catch (ex) {
                $('#comments-list').html(JSON.stringify(ex));
            }

        }
        let btn = null;
        async function editComment(button, id){
            let line = $(`#line${id}`);
            if($(button).text() === '수정'){
                obj = line.find('div:nth-child(2)').html();
                let input = `<input value="${obj}">`;
                line.find(`div:nth-child(2)`).html(input);
                line.find('input').focus();
                $(button).text('확인');
                $(button).next().text('취소');
            } else if($(button).text() === '확인'){
                if(obj !== line.find('input').val()){
                    try {
                        await $.ajax({
                            type: 'PUT',
                            url: '/comment',
                            data: JSON.stringify({
                                id,
                                content : line.find('input').val()
                            }),
                            contentType: 'application/json',
                            dataType: 'json',
                            success: function (response) {
                            console.log(response);
                            let input2 = `<div style="width: 350px; overflow: auto;">${response.content}</div>`
                            line.find(`div:nth-child(2)`).html(input2);

                        }
                        });
                    } catch (e) {
                        console.log("aa" + e);
                    }
                }
                $(button).text('수정');
                $(button).next().text('삭제');
            }
        }

        async function removeComment(button, id){
            if($(button).text() === '삭제') {
                try {
                    if (confirm('삭제하시겠습니까?') === true) {
                        $.ajax({
                            type: 'delete',
                            url: `http://localhost:8080/comment/${id}`,
                            success: function(response){
                                $(`#line${id}`).remove();
                                return;
                            }
                        });
                    }
                } catch (err) {
                    console.log(JSON.stringify(err));
                }
            }
            else if($(button).text() === '취소'){
                line.find(`div:nth-child(2)`).html(content);
                $(obj).text('수정');
                $(obj).next().text('삭제');
            }
        }


        let editValue = '';
        async function removeUser(button, id){
            if($(button).text() === '삭제') {


                try {
                    if (confirm('삭제하시겠습니까?') === true) {
                        $.ajax({
                            type: 'delete',
                            url: `http://localhost:8080/user/${id}`,
                        });
                        if (response == true) {
                            let line = $(`line${id}`).remove();
                        } else alert('삭제하지 못했습니다.');

                    }
                } catch (err) {
                    console.log(JSON.stringify(err));
                }
            } else if($(button).text() === '취소'){
                line.find(`div:nth-child(2)`).html(content);
                $(obj).text('수정');
                $(obj).next().text('삭제');
            }
        }
    </script>
</body>
</html>